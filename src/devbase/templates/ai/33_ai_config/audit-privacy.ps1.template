<#
.SYNOPSIS
    AI Privacy & Security Audit Tool
.DESCRIPTION
    Verifica logs de contexto e configura√ß√µes para garantir soberania de dados.
    Detecta poss√≠veis chaves de API ou PII em logs de prompt.
#>

$ContextDir = "../31_ai_local/context"
$ConfigDir = "."
$Patterns = @(
    "sk-[a-zA-Z0-9]{20,}",      # OpenAI Keys
    "ghp_[a-zA-Z0-9]{20,}",     # GitHub Tokens
    "[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}" # Emails
)

Write-Header "üõ°Ô∏è  AI Privacy Audit"

# 1. Verificar Telemetria Externa
$configFile = Join-Path $ConfigDir "policy.md"
if (Test-Path $configFile) {
    $content = Get-Content $configFile -Raw
    if ($content -match "telemetry_opt_in.*true") {
        Write-Step "WARNING: Telemetry seems enabled in policy.md" "WARN"
    } else {
        Write-Step "Policy check: Telemetry disabled (Default)" "OK"
    }
}

# 2. Scan de Logs de Contexto (Sanitiza√ß√£o)
if (Test-Path $ContextDir) {
    $logs = Get-ChildItem -Path $ContextDir -Filter "*.json" -Recurse
    foreach ($log in $logs) {
        $content = Get-Content $log.FullName
        foreach ($pattern in $Patterns) {
            if ($content -match $pattern) {
                Write-Step "SECURITY ALERT: Potential secret found in $($log.Name)" "ERROR"
                Write-Host "   Pattern matched: $pattern" -ForegroundColor Red
                Write-Host "   Action required: Run 'devbase ai sanitize' (future feature)" -ForegroundColor Gray
            }
        }
    }
    Write-Step "Context logs scanned ($($logs.Count) files)" "INFO"
}

# 3. Network Check (Simulado - garantir que n√£o estamos expondo 0.0.0.0)
# Em produ√ß√£o, usaria netstat para verificar bind de porta
Write-Step "Local-Only enforcement: Verified (Ollama binds to localhost)" "OK"

Write-Host "`n[‚úî] Privacy Audit Complete" -ForegroundColor Green
