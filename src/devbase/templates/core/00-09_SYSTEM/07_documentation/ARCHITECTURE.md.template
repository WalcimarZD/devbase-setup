# üèóÔ∏è Arquitetura do DevBase

> Documenta√ß√£o t√©cnica detalhada sobre como o DevBase funciona internamente.

---

## üìã Sum√°rio

1. [Vis√£o Geral](#1-vis√£o-geral)
2. [Componentes Principais](#2-componentes-principais)
3. [Fluxo de Execu√ß√£o](#3-fluxo-de-execu√ß√£o)
4. [Sistema de M√≥dulos](#4-sistema-de-m√≥dulos)
5. [Motor de Templates](#5-motor-de-templates)
6. [Engine de Migra√ß√£o](#6-engine-de-migra√ß√£o)
7. [CLI (Interface de Linha de Comando)](#7-cli-interface-de-linha-de-comando)
8. [Seguran√ßa](#8-seguran√ßa)
9. [Extensibilidade](#9-extensibilidade)
10. [Decis√µes de Design](#10-decis√µes-de-design)

---

## 1. Vis√£o Geral

### 1.1 Arquitetura de Alto N√≠vel

O DevBase √© organizado em m√≥dulos que trabalham em conjunto para criar um Personal Engineering Operating System.

### 1.2 Princ√≠pios Arquiteturais

| Princ√≠pio | Descri√ß√£o | Implementa√ß√£o |
|-----------|-----------|---------------|
| **Idempot√™ncia** | Executar m√∫ltiplas vezes produz mesmo resultado | `New-FileSafe` verifica exist√™ncia antes de criar |
| **Modularidade** | Funcionalidades separadas em m√≥dulos | Cada `setup-*.ps1` √© independente |
| **Declarativo** | Templates definem o estado desejado | Arquivos `.template` s√£o processados automaticamente |
| **Seguran√ßa** | Prote√ß√£o contra path traversal e vazamentos | `Assert-SafePath`, valida√ß√£o de BOM |
| **Portabilidade** | Funciona em Windows, Linux, macOS | PowerShell Core + fallback Python |

---

## 2. Componentes Principais

### 2.1 Responsabilidades dos M√≥dulos

| Componente | Responsabilidade | Localiza√ß√£o |
|------------|------------------|-------------|
| `main.py` | Orquestrar CLI Typer, registrar subcomandos | `src/devbase/main.py` |
| `commands/` | Grupos de comandos (core, dev, pkm, etc.) | `src/devbase/commands/` |
| `services/` | L√≥gica de neg√≥cio isolada | `src/devbase/services/` |
| `utils/` | Fun√ß√µes utilit√°rias (workspace, templates, etc.) | `src/devbase/utils/` |
| `templates/` | Templates Jinja2 para estrutura do workspace | `src/devbase/templates/` |

---

## 3. Fluxo de Execu√ß√£o

### 3.1 Ordem de Execu√ß√£o dos M√≥dulos

1. Core Structure       ‚Üí Estrutura base Johnny.Decimal
2. Knowledge Management ‚Üí PKM folders e templates
3. Code Templates       ‚Üí Templates de c√≥digo
4. AI Integration       ‚Üí M√≥dulo de IA local
5. Operations           ‚Üí CLI e automa√ß√£o

A ordem importa! M√≥dulos posteriores podem depender de estruturas criadas por m√≥dulos anteriores.

---

## 4. Sistema de M√≥dulos

### 4.1 Estrutura de um M√≥dulo

Cada m√≥dulo de comando em `commands/` segue um padr√£o consistente usando Typer para criar CLIs declarativas:

```python
import typer
from rich.console import Console

app = typer.Typer(help="Descri√ß√£o do grupo de comandos")
console = Console()

@app.command()
def meu_comando():
    """Executa a√ß√£o espec√≠fica."""
    console.print("[green]‚úì Comando executado![/green]")
```

### 4.2 Fun√ß√µes Utilit√°rias (utils/)

```python
# Fun√ß√µes de Workspace
from devbase.utils.workspace import detect_workspace_root

# Fun√ß√µes de Templates
from devbase.utils.templates import render_template

# Fun√ß√µes de Filesystem
from devbase.utils.filesystem import safe_copy, assert_safe_path
```

---

## 5. Motor de Templates

### 5.1 Como Templates Funcionam

Templates s√£o arquivos com extens√£o `.template` que cont√™m placeholders. O DevBase l√™ cada template, substitui os placeholders por valores din√¢micos, e salva o resultado sem a extens√£o `.template`.

### 5.2 Placeholders Dispon√≠veis

| Placeholder | Valor | Exemplo |
|-------------|-------|---------|
| `{{POLICY_VERSION}}` | Vers√£o da pol√≠tica | `3.1` |
| `{{DATE}}` | Data atual | `{{DATE}}` |
| `{{YEAR}}` | Ano atual | `{{YEAR}}` |
| `{{WEEK_NUMBER}}` | N√∫mero da semana | `{{WEEK_NUMBER}}` |

### 5.3 Conven√ß√£o de Nomes de Templates

```
[nome-arquivo].[extens√£o].template

Exemplos:
  README.md.template      ‚Üí README.md
  .gitignore.template     ‚Üí .gitignore
  pre-commit.ps1.template ‚Üí pre-commit.ps1
  ci-node.yml.template    ‚Üí ci-node.yml
```

---

## 6. Engine de Migra√ß√£o

### 6.1 Arquivo de Estado

O arquivo `.devbase_state.json` rastreia o estado do workspace e permite migra√ß√µes entre vers√µes.

### 6.2 Rastreamento de Migra√ß√µes

O arquivo de estado inclui:
- Vers√£o do DevBase instalada
- Data de instala√ß√£o
- Hist√≥rico de migra√ß√µes executadas
- Lista de m√≥dulos instalados

---

## 7. CLI (Interface de Linha de Comando)

### 7.1 Comandos Dispon√≠veis

| Comando | Descri√ß√£o |
|---------|-----------|
| `doctor` | Verifica integridade do workspace |
| `audit` | Audita nomenclatura (kebab-case) |
| `backup` | Executa backup 3-2-1 |
| `clean` | Limpa arquivos tempor√°rios |
| `new` | Cria novo projeto usando template |
| `link-dotfiles` | Sincroniza dotfiles para $HOME |
| `hydrate` | Atualiza todos os templates |
| `track` | Registra atividade |
| `stats` | Mostra estat√≠sticas de uso |
| `weekly` | Gera relat√≥rio semanal |
| `brag` | Gera brag document |

---

## 8. Seguran√ßa

### 8.1 Prote√ß√µes Implementadas

O DevBase implementa m√∫ltiplas camadas de seguran√ßa:

1. **Path Traversal Prevention** - Assert-SafePath valida caminhos
2. **BOM Sanitization** - Remove UTF-8 BOM de arquivos
3. **Air-Gap Enforcement** - Vault privado nunca sai da m√°quina
4. **Atomic Operations** - Escrita via temp file + rename
5. **Permission Checks** - Valida permiss√µes em arquivos sens√≠veis

---

## 9. Extensibilidade

### 9.1 Adicionando Novo M√≥dulo

Para adicionar um novo m√≥dulo:

1. Criar entry em `FOLDER_STRUCTURE` em `commands/core.py`
2. Criar templates em `templates/meunome/`
3. Adicionar fun√ß√£o de setup se necess√°rio

### 9.2 Adicionando Comando √† CLI

Para adicionar um novo comando:

1. Criar arquivo em `commands/meu_modulo.py` com Typer app
2. Registrar em `main.py` via `app.add_typer()`
3. Adicionar testes em `tests/`

---

## 10. Decis√µes de Design

### 10.1 Por que Python + Typer?

**Pr√≥s:**
- Cross-platform nativo (Windows, Linux, macOS)
- Ecossistema maduro de ferramentas
- Typer oferece CLI declarativa com type hints
- Rich proporciona output bonito e consist√™nte
- f√°cil de testar com pytest

**Contras:**
- Requer instala√ß√£o do Python (resolvido com `uv`)

### 10.2 Por que Johnny.Decimal?

- **Previsibilidade**: Sempre sei onde est√° cada tipo de conte√∫do
- **Escalabilidade**: Funciona de 10 arquivos a 100.000
- **Numera√ß√£o**: Permite ordena√ß√£o natural
- **√Åreas**: Separa√ß√£o clara de responsabilidades

---

## üìö Refer√™ncias

- [PowerShell Documentation](https://docs.microsoft.com/powershell/)
- [Johnny.Decimal](https://johnnydecimal.com/)
- [Conventional Commits](https://conventionalcommits.org/)
- [Clean Architecture](https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html)

---

<div align="center">

**Documento Gerado**: {{DATE}}
**Vers√£o**: {{POLICY_VERSION}}

[‚¨ÜÔ∏è Voltar ao topo](#Ô∏è-arquitetura-do-devbase)

</div>
