# üèóÔ∏è Arquitetura do DevBase

> Documenta√ß√£o t√©cnica detalhada sobre como o DevBase funciona internamente.

---

## üìã Sum√°rio

1. [Vis√£o Geral](#1-vis√£o-geral)
2. [Componentes Principais](#2-componentes-principais)
3. [Fluxo de Execu√ß√£o](#3-fluxo-de-execu√ß√£o)
4. [Sistema de M√≥dulos](#4-sistema-de-m√≥dulos)
5. [Motor de Templates](#5-motor-de-templates)
6. [Engine de Migra√ß√£o](#6-engine-de-migra√ß√£o)
7. [CLI (Interface de Linha de Comando)](#7-cli-interface-de-linha-de-comando)
8. [Seguran√ßa](#8-seguran√ßa)
9. [Extensibilidade](#9-extensibilidade)
10. [Decis√µes de Design](#10-decis√µes-de-design)

---

## 1. Vis√£o Geral

### 1.1 Arquitetura de Alto N√≠vel

O DevBase √© organizado em m√≥dulos que trabalham em conjunto para criar um Personal Engineering Operating System.

### 1.2 Princ√≠pios Arquiteturais

| Princ√≠pio | Descri√ß√£o | Implementa√ß√£o |
|-----------|-----------|---------------|
| **Idempot√™ncia** | Executar m√∫ltiplas vezes produz mesmo resultado | `New-FileSafe` verifica exist√™ncia antes de criar |
| **Modularidade** | Funcionalidades separadas em m√≥dulos | Cada `setup-*.ps1` √© independente |
| **Declarativo** | Templates definem o estado desejado | Arquivos `.template` s√£o processados automaticamente |
| **Seguran√ßa** | Prote√ß√£o contra path traversal e vazamentos | `Assert-SafePath`, valida√ß√£o de BOM |
| **Portabilidade** | Funciona em Windows, Linux, macOS | PowerShell Core + fallback Python |

---

## 2. Componentes Principais

### 2.1 Responsabilidades dos M√≥dulos

| Componente | Responsabilidade | Depend√™ncias |
|------------|------------------|--------------|
| `bootstrap.ps1` | Orquestrar execu√ß√£o, valida√ß√µes iniciais | `common-functions.ps1`, todos os `setup-*.ps1` |
| `common-functions.ps1` | Fun√ß√µes utilit√°rias (Write-Step, New-FileSafe, etc.) | Nenhuma |
| `setup-core.ps1` | Criar estrutura Johnny.Decimal base | `common-functions.ps1` |
| `setup-pkm.ps1` | Criar estrutura de conhecimento | `common-functions.ps1` |
| `setup-code.ps1` | Criar estrutura de c√≥digo e templates | `common-functions.ps1` |
| `setup-operations.ps1` | Instalar CLI e scripts de automa√ß√£o | `common-functions.ps1`, `assets/` |
| `setup-hooks.ps1` | Instalar e configurar git hooks | `common-functions.ps1` |
| `setup-ai.ps1` | Criar estrutura do m√≥dulo de IA | `common-functions.ps1` |
| `devbase.ps1.asset` | CLI do usu√°rio final | `common-functions.ps1` |

---

## 3. Fluxo de Execu√ß√£o

### 3.1 Ordem de Execu√ß√£o dos M√≥dulos

1. setup-core.ps1       ‚Üí Estrutura base Johnny.Decimal
2. setup-pkm.ps1        ‚Üí Knowledge Management (PKM)
3. setup-code.ps1       ‚Üí Templates de c√≥digo
4. setup-operations.ps1 ‚Üí CLI e automa√ß√£o
5. setup-templates.ps1  ‚Üí Padr√µes t√©cnicos
6. setup-hooks.ps1      ‚Üí Git hooks
7. setup-ai.ps1         ‚Üí M√≥dulo de IA local

A ordem importa! M√≥dulos posteriores podem depender de estruturas criadas por m√≥dulos anteriores.

---

## 4. Sistema de M√≥dulos

### 4.1 Estrutura de um M√≥dulo

Cada m√≥dulo `setup-*.ps1` segue um padr√£o consistente para processar templates e criar estruturas de diret√≥rios.

### 4.2 Fun√ß√µes Compartilhadas (common-functions.ps1)

```powershell
# Fun√ß√µes de Output
Write-Header "T√≠tulo"           # Exibe cabe√ßalho formatado
Write-Step "Mensagem" "OK"      # Exibe status [+] verde
Write-Step "Mensagem" "WARN"    # Exibe status [!] amarelo
Write-Step "Mensagem" "ERROR"   # Exibe status [X] vermelho
Write-Step "Mensagem" "INFO"    # Exibe status [i] ciano

# Fun√ß√µes de Seguran√ßa
Assert-SafePath -TargetPath $path -AllowedRoot $root  # Previne path traversal
Assert-NoBOM -Path $file                               # Remove BOM UTF-8

# Fun√ß√µes de Filesystem (At√¥micas)
New-DirSafe -Path $path         # Cria diret√≥rio se n√£o existir
Write-FileAtomic -Path $path -Content $content  # Escrita at√¥mica via temp file
New-FileSafe -Path $path -Content $content      # Cria arquivo se n√£o existir
Copy-ItemAtomic -Source $src -Destination $dest    # C√≥pia at√¥mica
```

---

## 5. Motor de Templates

### 5.1 Como Templates Funcionam

Templates s√£o arquivos com extens√£o `.template` que cont√™m placeholders. O DevBase l√™ cada template, substitui os placeholders por valores din√¢micos, e salva o resultado sem a extens√£o `.template`.

### 5.2 Placeholders Dispon√≠veis

| Placeholder | Valor | Exemplo |
|-------------|-------|---------|
| `{{POLICY_VERSION}}` | Vers√£o da pol√≠tica | `3.1` |
| `{{DATE}}` | Data atual | `{{DATE}}` |
| `{{YEAR}}` | Ano atual | `{{YEAR}}` |
| `{{WEEK_NUMBER}}` | N√∫mero da semana | `{{WEEK_NUMBER}}` |

### 5.3 Conven√ß√£o de Nomes de Templates

```
[nome-arquivo].[extens√£o].template

Exemplos:
  README.md.template      ‚Üí README.md
  .gitignore.template     ‚Üí .gitignore
  pre-commit.ps1.template ‚Üí pre-commit.ps1
  ci-node.yml.template    ‚Üí ci-node.yml
```

---

## 6. Engine de Migra√ß√£o

### 6.1 Arquivo de Estado

O arquivo `.devbase_state.json` rastreia o estado do workspace e permite migra√ß√µes entre vers√µes.

### 6.2 Rastreamento de Migra√ß√µes

O arquivo de estado inclui:
- Vers√£o do DevBase instalada
- Data de instala√ß√£o
- Hist√≥rico de migra√ß√µes executadas
- Lista de m√≥dulos instalados

---

## 7. CLI (Interface de Linha de Comando)

### 7.1 Comandos Dispon√≠veis

| Comando | Descri√ß√£o |
|---------|-----------|
| `doctor` | Verifica integridade do workspace |
| `audit` | Audita nomenclatura (kebab-case) |
| `backup` | Executa backup 3-2-1 |
| `clean` | Limpa arquivos tempor√°rios |
| `new` | Cria novo projeto usando template |
| `link-dotfiles` | Sincroniza dotfiles para $HOME |
| `hydrate` | Atualiza todos os templates |
| `track` | Registra atividade |
| `stats` | Mostra estat√≠sticas de uso |
| `weekly` | Gera relat√≥rio semanal |
| `brag` | Gera brag document |

---

## 8. Seguran√ßa

### 8.1 Prote√ß√µes Implementadas

O DevBase implementa m√∫ltiplas camadas de seguran√ßa:

1. **Path Traversal Prevention** - Assert-SafePath valida caminhos
2. **BOM Sanitization** - Remove UTF-8 BOM de arquivos
3. **Air-Gap Enforcement** - Vault privado nunca sai da m√°quina
4. **Atomic Operations** - Escrita via temp file + rename
5. **Permission Checks** - Valida permiss√µes em arquivos sens√≠veis

---

## 9. Extensibilidade

### 9.1 Adicionando Novo M√≥dulo

Para adicionar um novo m√≥dulo:

1. Criar `modules/setup-meunome.ps1`
2. Criar `modules/templates/meunome/` com templates
3. Adicionar ao array de m√≥dulos em `bootstrap.ps1`
4. Chamar a fun√ß√£o no fluxo de execu√ß√£o

### 9.2 Adicionando Comando √† CLI

Para adicionar um novo comando:

1. Adicionar ao `ValidateSet` em `devbase.ps1`
2. Criar fun√ß√£o `Invoke-MeuComando`
3. Adicionar ao switch de comandos

---

## 10. Decis√µes de Design

### 10.1 Por que PowerShell?

**Pr√≥s:**
- Nativo no Windows (sem instala√ß√£o)
- PowerShell Core funciona em Linux/macOS
- Sintaxe expressiva para manipula√ß√£o de arquivos
- Objetos ao inv√©s de strings (mais robusto)

**Contras:**
- Menos familiar para desenvolvedores Unix
- Performance em opera√ß√µes massivas

### 10.2 Por que Johnny.Decimal?

- **Previsibilidade**: Sempre sei onde est√° cada tipo de conte√∫do
- **Escalabilidade**: Funciona de 10 arquivos a 100.000
- **Numera√ß√£o**: Permite ordena√ß√£o natural
- **√Åreas**: Separa√ß√£o clara de responsabilidades

---

## üìö Refer√™ncias

- [PowerShell Documentation](https://docs.microsoft.com/powershell/)
- [Johnny.Decimal](https://johnnydecimal.com/)
- [Conventional Commits](https://conventionalcommits.org/)
- [Clean Architecture](https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html)

---

<div align="center">

**Documento Gerado**: {{DATE}}  
**Vers√£o**: {{POLICY_VERSION}}

[‚¨ÜÔ∏è Voltar ao topo](#Ô∏è-arquitetura-do-devbase)

</div>
