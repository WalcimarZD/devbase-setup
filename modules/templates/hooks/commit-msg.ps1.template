#! /usr/bin/env pwsh
# DevBase v3.0 - Commit Message Hook (PowerShell)
#
# Valida mensagens de commit seguindo Conventional Commits.

$commitMsgFile = $args[0]
$commitMsg = Get-Content $commitMsgFile -Raw

Write-Host "ðŸ” Validating commit message..." -ForegroundColor Cyan

$pattern = "^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\([a-z0-9-]+\))?(!)?: .{1,100}$"
$firstLine = ($commitMsg -split "`r`n?|`n")[0]

if (-not $firstLine) {
    Write-Host "âŒ Commit message is empty" -ForegroundColor Red
    exit 1
}

if ($firstLine -match "^Merge" -or $firstLine -match "^Revert") {
    Write-Host "âœ… Merge/Revert commit - skipping validation" -ForegroundColor Green
    exit 0
}

if (-not ($firstLine -match $pattern)) {
    Write-Host ""
    Write-Host "âŒ Invalid commit message format!" -ForegroundColor Red
    Write-Host "   Expected: type(scope): description"
    Write-Host "   Your msg: $firstLine"
    Write-Host "   (See DevBase docs for Conventional Commits standard)"
    Write-Host ""
    exit 1
}

if ($firstLine.Length -gt 100) {
    Write-Host "âŒ Commit message header too long ($($firstLine.Length) > 100 chars)" -ForegroundColor Red
    exit 1
}

Write-Host "âœ… Commit message is valid!" -ForegroundColor Green
exit 0
