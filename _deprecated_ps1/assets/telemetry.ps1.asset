<#
.SYNOPSIS
  DevBase Telemetry CLI - records local usage stats, generates weekly summaries and brag docs.

.DESCRIPTION
  Subcommands:
    record    - Appends an event to .telemetry/events.jsonl
    stats     - Prints summary of events
    weekly    - Generates a weekly summary (Markdown)
    brag      - Generates a brag-doc draft from events

  Data is stored in <DevBase>/.telemetry/

.NOTES
  Author: DevBase
  Version: 1.0.0
#>

[CmdletBinding()]
param(
    [Parameter(Mandatory = $true, Position = 0)]
    [ValidateSet('record', 'stats', 'weekly', 'brag')]
    [string]$Command,

    [Parameter(Position = 1)]
    [string]$EventType,

    [Parameter(Position = 2)]
    [string]$Message,

    [string]$OutputPath,
    [switch]$Help
)

function Show-Usage {
    Write-Host "Usage: telemetry.ps1 <record|stats|weekly|brag> [options]"
    Write-Host "  record <type> <message>  - Record an event (e.g., 'commit', 'deploy', 'review')"
    Write-Host "  stats                    - Show summary statistics"
    Write-Host "  weekly [-OutputPath <path>] - Generate weekly summary"
    Write-Host "  brag [-OutputPath <path>]   - Generate brag doc draft"
}

if ($Help) { Show-Usage; exit 0 }

# Resolve DevBase root (two levels up from 35_devbase_cli)
$scriptRoot = Split-Path -Parent $MyInvocation.MyCommand.Path
$devbaseRoot = Split-Path -Parent (Split-Path -Parent $scriptRoot)
$telemetryDir = Join-Path $devbaseRoot ".telemetry"
$eventsFile = Join-Path $telemetryDir "events.jsonl"

function Ensure-TelemetryDir {
    if (-not (Test-Path $telemetryDir)) {
        New-Item -ItemType Directory -Path $telemetryDir -Force | Out-Null
        Write-Host "Created telemetry directory: $telemetryDir"
    }
}

function Record-Event {
    param([string]$Type, [string]$Msg)
    if (-not $Type) { Write-Error "Event type required"; exit 1 }
    Ensure-TelemetryDir
    $event = @{
        type       = $Type
        message    = $Msg
        timestamp  = (Get-Date).ToString('o')
        user       = $env:USERNAME
        host       = $env:COMPUTERNAME
    }
    $json = $event | ConvertTo-Json -Compress
    Add-Content -Path $eventsFile -Value $json -Encoding UTF8
    Write-Host "Recorded event: $Type"
}

function Get-Events {
    if (-not (Test-Path $eventsFile)) { return @() }
    Get-Content $eventsFile | ForEach-Object { $_ | ConvertFrom-Json }
}

function Show-Stats {
    $events = Get-Events
    if (-not $events -or $events.Count -eq 0) {
        Write-Host "No events recorded yet."
        return
    }
    $total = $events.Count
    $byType = $events | Group-Object -Property type | Sort-Object Count -Descending
    Write-Host "Total events: $total"
    Write-Host "By type:"
    foreach ($g in $byType) {
        Write-Host ("  {0}: {1}" -f $g.Name, $g.Count)
    }
    $first = $events | Sort-Object timestamp | Select-Object -First 1
    $last = $events | Sort-Object timestamp | Select-Object -Last 1
    Write-Host "First event: $($first.timestamp)"
    Write-Host "Last event:  $($last.timestamp)"
}

function Generate-Weekly {
    param([string]$Out)
    $events = Get-Events
    $now = Get-Date
    $weekAgo = $now.AddDays(-7)
    $recent = $events | Where-Object { [datetime]$_.timestamp -ge $weekAgo }
    $md = @()
    $md += "# Weekly Summary"
    $md += ""
    $md += "Generated: $($now.ToString('yyyy-MM-dd HH:mm'))"
    $md += ""
    $md += "## Events (last 7 days)"
    $md += ""
    if ($recent.Count -eq 0) {
        $md += "_No events recorded in the last 7 days._"
    }
    else {
        $byType = $recent | Group-Object -Property type | Sort-Object Count -Descending
        foreach ($g in $byType) {
            $md += "- **$($g.Name)**: $($g.Count)"
        }
        $md += ""
        $md += "### Recent highlights"
        $md += ""
        $highlights = $recent | Sort-Object timestamp -Descending | Select-Object -First 10
        foreach ($e in $highlights) {
            $ts = ([datetime]$e.timestamp).ToString('MM-dd HH:mm')
            $md += "- [$ts] $($e.type): $($e.message)"
        }
    }
    $content = $md -join "`n"
    if ($Out) {
        $content | Out-File -FilePath $Out -Encoding UTF8
        Write-Host "Weekly summary written to: $Out"
    }
    else {
        Write-Output $content
    }
}

function Generate-Brag {
    param([string]$Out)
    $events = Get-Events
    $now = Get-Date
    $md = @()
    $md += "# Brag Document"
    $md += ""
    $md += "Generated: $($now.ToString('yyyy-MM-dd HH:mm'))"
    $md += ""
    if ($events.Count -eq 0) {
        $md += "_No events recorded yet._"
    }
    else {
        $byType = $events | Group-Object -Property type | Sort-Object Count -Descending
        $md += "## Summary"
        $md += ""
        foreach ($g in $byType) {
            $md += "- **$($g.Name)**: $($g.Count) events"
        }
        $md += ""
        $md += "## Highlights"
        $md += ""
        $highlights = $events | Sort-Object timestamp -Descending | Select-Object -First 20
        foreach ($e in $highlights) {
            $ts = ([datetime]$e.timestamp).ToString('yyyy-MM-dd')
            $md += "- [$ts] $($e.type): $($e.message)"
        }
    }
    $content = $md -join "`n"
    if ($Out) {
        $content | Out-File -FilePath $Out -Encoding UTF8
        Write-Host "Brag doc written to: $Out"
    }
    else {
        Write-Output $content
    }
}

switch ($Command) {
    'record' {
        Record-Event -Type $EventType -Msg $Message
    }
    'stats' {
        Show-Stats
    }
    'weekly' {
        Generate-Weekly -Out $OutputPath
    }
    'brag' {
        Generate-Brag -Out $OutputPath
    }
    Default {
        Show-Usage
        exit 1
    }
}
